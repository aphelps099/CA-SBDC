!function(o){function e(e){e.preventDefault();var t,r=o(this).closest(".crown-field.repeater").find("> .input-wrap > .field-repeater-entries"),a=null,n=!1;o(this).closest(".crown-field.repeater").hasClass("flex-repeater")?(o(".crown-field.flex-repeater .add-flex-field-repeater-entry-options.active").removeClass("active"),o(".crown-field.flex-repeater .entry > .add-field-repeater-entry-container.active").removeClass("active"),t=o(this).data("entry-type"),a=o("> .entry.tpl.type-"+t,r).clone(),o(this).closest(".add-flex-field-repeater-entry-options").is(".mid-list.before")&&(n=o(this).closest(".entry"))):(a=o("> .entry.tpl",r).clone(),o(this).is(".mid-list.before")&&(n=o(this).closest(".entry")));var i=(new Date).getTime();a.removeClass("tpl"),o("input, select, textarea",a).each(function(e,t){var r,a;o(t).closest(".field-repeater-entries").length?o(t).hasClass("rich-textarea-settings")?o(t).val(o(t).val().replace("{{index}}","new_entry_"+i)):o(t).data("tpl-name")&&o(t).attr("data-tpl-name",o(t).data("tpl-name").replace("{{index}}","new_entry_"+i)):o(t).hasClass("rich-textarea-settings")?(r=o(t),(a=JSON.parse(r.val())).action="get_rich_textarea",a.id=a.id+i,a.settings.textarea_name=a.settings.textarea_name.replace("{{index}}","new_entry_"+i),o.get(crownFormFieldRepeaterData.ajaxUrl,a,function(e){r.after(e),r.remove(),o("textarea.wp-editor-area",e).each(function(e,t){var r=o(t).attr("id"),a=tinyMCEPreInit.mceInit[r];a.setup=function(e){e.on("init",function(e){o("#wp-"+r+"-wrap").hasClass("html-active")&&(o("#wp-"+r+"-wrap textarea.wp-editor-area").show(),o("#wp-"+r+"-wrap .mce-tinymce").hide(),o("#"+r+"-html").trigger("click"))})},tinyMCE.init(a),quicktags(tinyMCEPreInit.qtInit[r]),QTags._buttonsInit()})})):o(t).data("tpl-name")&&(o(t).attr("name",o(t).data("tpl-name").replace("{{index}}","new_entry_"+i)),1==o(t).data("tpl-required")&&o(t).attr("required",!0))}),o(".crown-gallery-input",a).each(function(e,t){o(t).attr("data-basename",o(t).attr("data-basename").replace("{{index}}","new_entry_"+i))}),o(".google-map.map-configured",a).each(function(e,t){var r,a;o(t).closest(".entry").hasClass("tpl")||(r=o(t).attr("id"),a="google-map-"+Math.floor(2147483647*Math.random()),o(t).attr("id",a),o(t).next("script").html(o(t).next("script").html().replace(r,a)),window.googleMapSettings[a]=o.extend({},window.googleMapSettings[r],{autoInit:!0}))}),o(".crown-field.repeater .field-repeater-entries",a).sortable({items:"> .entry:not(.tpl)",handle:"> .sort-handle"}).on("sortstart",function(e){e.stopPropagation(),l(e,!1)}).on("sortstop",function(e){e.stopPropagation(),l(e,!0)}),o(".crown-checkbox-set-input.sortable > .inner",a).sortable(),n&&n.length?n.before(a):r.append(a),o(".crown-colorpicker-input",a).trigger("initColorpicker"),o(".google-map.map-configured",a).each(function(e,t){o(t).closest(".entry").hasClass("tpl")||o(t).trigger("googleMapAutoInit")}),a.trigger("repeaterEntryAdded")}function t(e){e.preventDefault();var t=o(this).closest(".entry");t.hasClass("tpl")||confirm("Are you sure you want to remove this entry?")&&(t.trigger("repeaterEntryRemove"),t.remove())}function l(e,n){o("textarea.wp-editor-area",o(e.srcElement).closest(".entry")).each(function(e,t){var r=tinyMCE.get(t.id),a=o(t).parents(".tmce-active").length;n?!r&&a&&tinyMCE.execCommand("mceAddEditor",!0,t.id):r&&(r.save(),tinyMCE.execCommand("mceRemoveEditor",!0,t.id))})}o(document).ready(function(){o(document).on("click",".crown-field.repeater .add-field-repeater-entry",e),o(document).on("click",".crown-field.flex-repeater .add-flex-field-repeater-entry-options .options a",e),o(document).on("click",".crown-field.repeater .entry .remove-field-repeater-entry",t),o(".crown-field.repeater.flex-repeater").each(function(e,t){var r=o("> .input-wrap > .add-flex-field-repeater-entry-options",t);o("> .input-wrap > .field-repeater-entries > .entry",t).each(function(e,t){o("> .add-field-repeater-entry-container.before",t).append(r.clone().addClass("mid-list before")),o("> .add-field-repeater-entry-container.after",t).append(r.clone().addClass("mid-list after"))})}),o(".crown-field.repeater .field-repeater-entries").sortable({items:"> .entry:not(.tpl)",handle:"> .sort-handle, > .entry-header"}).on("sortstart",function(e){e.stopPropagation(),l(e,!1)}).on("sortstop",function(e){e.stopPropagation(),l(e,!0)}),o(document).on("click",".crown-field.repeater .entry .entry-header",function(e){o(this).closest(".entry").toggleClass("collapsed")}),o(document).on("click",".crown-field.flex-repeater .add-flex-field-repeater-entry-options .dropdown-toggle",function(e){e.preventDefault(),e.stopPropagation();var t=o(this).closest(".add-flex-field-repeater-entry-options");o(".crown-field.flex-repeater .add-flex-field-repeater-entry-options.active").not(t).removeClass("active"),t.toggleClass("active");var r=!!t.is(".mid-list")&&t.parent();r&&r.length?(o(".crown-field.flex-repeater .entry > .add-field-repeater-entry-container.active").not(r).removeClass("active"),r.toggleClass("active")):o(".crown-field.flex-repeater .entry > .add-field-repeater-entry-container.active").removeClass("active")}),o(document).on("click",".crown-field.flex-repeater .add-flex-field-repeater-entry-options .dropdown",function(e){e.stopPropagation()}),o(document).on("click",function(e){o(".crown-field.flex-repeater .add-flex-field-repeater-entry-options.active").removeClass("active"),o(".crown-field.flex-repeater .entry > .add-field-repeater-entry-container.active").removeClass("active")}),o(document).on("click",".crown-field.repeater .field-repeater-entry-controls .collapse-expand",function(e){e.preventDefault();var t=o(this).closest(".field-repeater-entry-controls").siblings(".field-repeater-entries").children().not(".tpl");t.filter(".collapsed").length==t.length?t.removeClass("collapsed"):t.addClass("collapsed")})})}(jQuery);